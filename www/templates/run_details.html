{% extends "base_run.html" %}

{% block title %}D&eacute;tails de sortie{% end %}
{% block title_h1 %}D&eacute;tails de sortie{% end %}

{% block subcontent %}
{% set latitude=corresponding_ids['latitude'] %}
{% set longitude=corresponding_ids['longitude'] %}
{% set altitude=corresponding_ids['altitude'] %}
{% set time=corresponding_ids['time'] %}
{% set datetime=corresponding_ids['datetime'] %}
{% set distance=corresponding_ids['distance'] %}
  <script src="http://maps.googleapis.com/maps/api/js?key={{ google_key}}&sensor=false"></script>
  <div id="map" style="width:500px;height:380px;"></div>
  <script type="text/javascript">
    var path = [
      {% for pt in run_path %}
        {
          lat: {{ pt[latitude] }}, long: {{ pt[longitude] }},
          alt: {{ pt[altitude] }}, time: {{ pt[time] }},
          date: {{ pt[datetime] }}, dist: {{ pt[distance]}},
        },
      {% end %}
    ];
    
    var pinColor = "FE7569";
    var pinImage = new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|" + pinColor,
        new google.maps.Size(21, 34),
        new google.maps.Point(0,0),
        new google.maps.Point(10, 34));
    
    function initialize() {
      var bounds = new google.maps.LatLngBounds();
      var map_pts = [];
      for (var i=0 ; i!=path.length ; i++) {
        var pt = new google.maps.LatLng(path[i]['lat'], path[i]['long']);
        map_pts.push(pt);
        bounds.extend(pt);
      }
      var map_pts_polyline = new google.maps.Polyline({
        path: map_pts,
        strokeColor: "#0000FF",
        strokeOpacity: 0.5,
        strokeWeight: 2
      });
      
      var mapProp = {
        mapTypeId: google.maps.MapTypeId.ROADMAP,
      };
      var map = new google.maps.Map(document.getElementById("map"), mapProp);
      
      map_pts_polyline.setMap(map);
      
      var marker_begin = new google.maps.Marker({
        position: map_pts[0],
      });
      marker_begin.setMap(map);
      var infowindow_begin = new google.maps.InfoWindow({
        content: "Départ le " + formatSortedTableData(path[0]['date'], 'datetime'),
      });
      google.maps.event.addListener(marker_begin, 'click', function() {
        infowindow_begin.open(map, marker_begin);
      });
      
      var marker_end = new google.maps.Marker({
        position: map_pts[map_pts.length -1],
      });
      marker_end.setMap(map);
      var infowindow_end = new google.maps.InfoWindow({
        content: "Arrivée le " + formatSortedTableData(path[path.length -1]['date'], 'datetime'),
      });
      google.maps.event.addListener(marker_end, 'click', function() {
        infowindow_end.open(map, marker_end);
      });
      
      map.fitBounds(bounds);
      map.panToBounds(bounds);
    }
    google.maps.event.addDomListener(window, 'load', initialize);
  </script>
{% end %}
